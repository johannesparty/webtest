<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,500,600&display=swap">
    <title>LandPKS JSON Export Format</title>
    <style>
        :root {
            --primary-color: #2c5530;
            --secondary-color: #4a7c4e;
            --bg-color: #ffffff;
            --card-bg: #c7c7c7;
            --border-color: #808080;
            --text-color: #333;
            --text-muted: #666;
            --code-bg: rgba(0, 0, 0, 0);
        }
        * { box-sizing: border-box; }
        body {
            font-family: Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--bg-color);
            margin: 0;
            padding: 0;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        header { background: var(--primary-color); color: white; padding: 30px 20px; margin-bottom: 30px; }
        header h1 { margin: 0 0 10px 0; font-size: 2em; }
        header p { margin: 0; opacity: 0.9; }
        nav {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 25px;
        }
        nav a {
            display: inline-block;
            padding: 6px 14px;
            margin: 3px;
            background: var(--code-bg);
            border-radius: 4px;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.9em;
        }
        nav a:hover { background: var(--secondary-color); color: white; }
        section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }
        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-top: 0;
            font-size: 1.4em;
        }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9em; table-layout: fixed; }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
            overflow-wrap: break-word;
        }
        th { background: var(--code-bg); font-weight: 600; color: var(--primary-color); white-space: nowrap; }
        tr:hover { background: var(--bg-color); }
        code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", Monaco, "Courier New", monospace;
            font-size: 0.85em;
        }
        td:first-child code { display: block; }
        .type { color: var(--secondary-color); }
        .description { color: var(--text-muted); margin-bottom: 15px; }
        .muted { color: var(--text-muted); }
        footer { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85em; }
        footer a { color: var(--secondary-color); }
        #loading { text-align: center; padding: 50px; color: var(--text-muted); }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>LandPKS JSON Export Format</h1>
            <p>Documentation for the JSON format returned by the export API</p>
        </div>
    </header>
    <div class="container">
        <div id="loading">Loading...</div>
        <nav id="nav" style="display:none;"></nav>
        <div id="content"></div>
        <footer>
            Dynamic version Â· <a href="https://github.com/techmatters/terraso-backend">terraso-backend</a>
        </footer>
    </div>

    <script>
    // CSV Parser
    function parseCSV(text) {
        const lines = text.trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
        const headers = parseCSVLine(lines[0]);
        return lines.slice(1).filter(line => line.trim()).map(line => {
            const values = parseCSVLine(line);
            const obj = {};
            headers.forEach((h, i) => obj[h] = values[i] || '');
            return obj;
        });
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current);
        return result;
    }

    function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    async function loadData() {
        const [objectsRes, fieldsRes, enumValuesRes] = await Promise.all([
            fetch('objects.csv'),
            fetch('fields.csv'),
            fetch('enum_values.csv')
        ]);
        return {
            objects: parseCSV(await objectsRes.text()),
            fields: parseCSV(await fieldsRes.text()),
            enumValues: parseCSV(await enumValuesRes.text())
        };
    }

    function buildParentMap(fields, objectNames) {
        const parentMap = {};
        for (const field of fields) {
            const ftype = field.type || '';
            const fname = field.json_name || '';
            const parentObj = field.object || '';
            if (!fname) continue;
            const isArray = ftype.endsWith('[]');
            const baseType = isArray ? ftype.slice(0, -2) : ftype;
            if (objectNames.has(baseType)) {
                parentMap[baseType] = { parent: parentObj, field: fname, isArray };
            }
        }
        return parentMap;
    }

    function computeJsonPath(objName, parentMap) {
        if (objName === 'Site' || objName === 'Location') return 'sites[]';
        if (!parentMap[objName]) return '';
        const { parent, field, isArray } = parentMap[objName];
        const parentPath = computeJsonPath(parent, parentMap);
        return `${parentPath}.${field}${isArray ? '[]' : ''}`;
    }

    function render(data) {
        const { objects, fields, enumValues } = data;
        const objectNames = new Set(objects.map(o => o.name));
        const objectDesc = Object.fromEntries(objects.map(o => [o.name, o.description]));

        // Group fields by object
        const fieldsByObject = {};
        for (const f of fields) {
            const obj = f.object || '';
            if (!fieldsByObject[obj]) fieldsByObject[obj] = [];
            fieldsByObject[obj].push(f);
        }

        // Merge Location into Site
        if (fieldsByObject.Location && fieldsByObject.Site) {
            fieldsByObject.Site.push(...fieldsByObject.Location);
            delete fieldsByObject.Location;
        }

        // Group enum values
        const valuesByEnum = {};
        for (const v of enumValues) {
            const e = v.enum || '';
            if (!valuesByEnum[e]) valuesByEnum[e] = [];
            valuesByEnum[e].push(v);
        }

        const parentMap = buildParentMap(fields, objectNames);
        const isJsonField = f => !!f.json_name;

        // Filter objects with JSON fields
        const jsonObjects = objects.filter(obj => {
            if (obj.name === 'Location') return false;
            const objFields = fieldsByObject[obj.name] || [];
            return objFields.some(isJsonField);
        });

        // Build navigation
        const navHtml = ['<a href="#overview">Overview</a>'];
        for (const obj of jsonObjects) {
            navHtml.push(`<a href="#obj-${obj.name.toLowerCase()}">${escapeHtml(obj.name)}</a>`);
        }
        navHtml.push('<span class="muted" style="margin-left: 20px;">See also: <a href="csv_dynamic.html">CSV Format</a></span>');
        document.getElementById('nav').innerHTML = navHtml.join(' ');
        document.getElementById('nav').style.display = 'block';

        // Build content
        let contentHtml = '';

        // Overview with structure
        const link = (name, obj, isArray = false) =>
            `<a href="#obj-${obj.toLowerCase()}">${name}${isArray ? '[]' : ''}</a>`;

        const structureHtml = `${link('sites', 'Site', true)}
  ${link('project', 'Project')}
    ${link('soilSettings', 'SoilSettings')}
      ${link('depthIntervals', 'ProjectDepthInterval', true)}
  ${link('soilData', 'SoilData')}
    ${link('_depthIntervals', 'DepthInterval', true)}
  ${link('notes', 'Note', true)}
    ${link('author', 'Author')}
  ${link('soil_id', 'SoilMatches')}
    ${link('matches', 'SoilMatch', true)}
      ${link('combinedMatch', 'MatchScore')}
      ${link('dataMatch', 'MatchScore')}
      ${link('locationMatch', 'MatchScore')}
      ${link('soilInfo', 'SoilInfo')}
        ${link('soilSeries', 'SoilSeries')}
        ${link('ecologicalSite', 'EcologicalSite')}
        ${link('landCapabilityClass', 'LandCapabilityClass')}
        ${link('soilData', 'MatchSoilData')}
          ${link('depthDependentData', 'MatchDepthData', true)}`;

        contentHtml += `<section id="overview">
            <h2>Overview</h2>
            <p>The export API returns site data in JSON format with the following structure. Click on field names to jump to their documentation.</p>
            <pre><code>${structureHtml}</code></pre>
            <p>Fields starting with <code>_</code> are derived fields expanded by the export for convenience.</p>
        </section>`;

        // Object sections
        for (const obj of jsonObjects) {
            const name = obj.name;
            const desc = obj.description || '';
            const path = computeJsonPath(name, parentMap);
            const objFields = (fieldsByObject[name] || []).filter(isJsonField);

            if (!objFields.length) continue;

            let tableRows = '';
            for (const f of objFields) {
                const fname = f.json_name || '';
                const ftype = f.type || '';
                const fdesc = f.description || '';

                const isArray = ftype.endsWith('[]');
                const baseType = isArray ? ftype.slice(0, -2) : ftype;
                const fnameHtml = `<code>${escapeHtml(fname)}${isArray ? '[]' : ''}</code>`;

                let typeHtml;
                if (valuesByEnum[baseType]) {
                    const vals = valuesByEnum[baseType].map(v => escapeHtml(v.value));
                    typeHtml = vals.join(', ');
                } else if (baseType === 'boolean') {
                    typeHtml = '<span class="type">true, false</span>';
                } else if (baseType === 'datetime') {
                    typeHtml = '<span class="type">ISO 8601 DateTime</span>';
                } else if (objectNames.has(baseType)) {
                    typeHtml = `<a href="#obj-${baseType.toLowerCase()}">${escapeHtml(baseType)}</a>`;
                } else {
                    typeHtml = `<span class="type">${escapeHtml(baseType)}</span>`;
                }

                tableRows += `<tr><td>${fnameHtml}</td><td>${typeHtml}</td><td>${escapeHtml(fdesc)}</td></tr>`;
            }

            contentHtml += `<section id="obj-${name.toLowerCase()}">
                <h2>${escapeHtml(name)}</h2>
                ${desc ? `<p class="description">${escapeHtml(desc)}</p>` : ''}
                ${path ? `<p class="muted">JSON path: <code>${escapeHtml(path)}</code></p>` : ''}
                <table>
                    <tr><th style="width:20%">Field</th><th style="width:20%">Type</th><th style="width:60%">Description</th></tr>
                    ${tableRows}
                </table>
            </section>`;
        }

        document.getElementById('content').innerHTML = contentHtml;
        document.getElementById('loading').style.display = 'none';
    }

    loadData().then(render).catch(err => {
        document.getElementById('loading').innerHTML = `Error loading data: ${err.message}`;
    });
    </script>
</body>
</html>
