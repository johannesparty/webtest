<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandPKS CSV Export Format</title>
    <style>
        :root {
            --primary-color: #2c5530;
            --secondary-color: #4a7c4e;
            --bg-color: #ffffff;
            --card-bg: #c7c7c7;
            --border-color: #808080;
            --text-color: #333;
            --text-muted: #666;
            --code-bg: rgba(0, 0, 0, 0);
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--bg-color);
            margin: 0;
            padding: 0;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        header { background: var(--primary-color); color: white; padding: 30px 20px; margin-bottom: 30px; }
        header h1 { margin: 0 0 10px 0; font-size: 2em; }
        header p { margin: 0; opacity: 0.9; }
        nav {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 25px;
        }
        nav a {
            display: inline-block;
            padding: 6px 14px;
            margin: 3px;
            background: var(--code-bg);
            border-radius: 4px;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.9em;
        }
        nav a:hover { background: var(--secondary-color); color: white; }
        section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }
        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-top: 0;
            font-size: 1.4em;
        }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9em; table-layout: fixed; }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
            overflow-wrap: break-word;
        }
        th { background: var(--code-bg); font-weight: 600; color: var(--primary-color); white-space: nowrap; }
        tr:hover { background: var(--bg-color); }
        code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", Monaco, "Courier New", monospace;
            font-size: 0.85em;
        }
        .type { color: var(--secondary-color); }
        .description { color: var(--text-muted); margin-bottom: 15px; }
        .muted { color: var(--text-muted); }
        footer { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85em; }
        footer a { color: var(--secondary-color); }
        #loading { text-align: center; padding: 50px; color: var(--text-muted); }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>LandPKS CSV Export Format</h1>
            <p>Documentation for the CSV format returned by the export API</p>
        </div>
    </header>
    <div class="container">
        <div id="loading">Loading...</div>
        <nav id="nav" style="display:none;"></nav>
        <div id="content"></div>
        <footer>
            Dynamic version Â· <a href="https://github.com/techmatters/terraso-backend">terraso-backend</a>
        </footer>
    </div>

    <script>
    // CSV Parser
    function parseCSV(text) {
        const lines = text.trim().replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
        const headers = parseCSVLine(lines[0]);
        return lines.slice(1).filter(line => line.trim()).map(line => {
            const values = parseCSVLine(line);
            const obj = {};
            headers.forEach((h, i) => obj[h] = values[i] || '');
            return obj;
        });
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current);
        return result;
    }

    function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    async function loadData() {
        const [fieldsRes, enumValuesRes] = await Promise.all([
            fetch('fields.csv'),
            fetch('enum_values.csv')
        ]);
        return {
            fields: parseCSV(await fieldsRes.text()),
            enumValues: parseCSV(await enumValuesRes.text())
        };
    }

    function render(data) {
        const { fields, enumValues } = data;

        // Group enum values by enum (use labels for CSV)
        const valuesByEnum = {};
        for (const v of enumValues) {
            const e = v.enum || '';
            if (!valuesByEnum[e]) valuesByEnum[e] = [];
            valuesByEnum[e].push(v);
        }

        // Get fields with CSV columns, grouped by object
        const csvFields = fields.filter(f => f.csv_column);
        const fieldsByObject = {};
        for (const f of csvFields) {
            const obj = f.object || '';
            if (!fieldsByObject[obj]) fieldsByObject[obj] = [];
            fieldsByObject[obj].push(f);
        }

        // Section definitions
        const sections = [
            ['Site', 'Site'],
            ['Project', 'Project'],
            ['Location', 'Location'],
            ['SoilMatches', 'Soil Matches'],
            ['EcologicalSite', 'Ecological Site'],
            ['SoilData', 'Soil Data'],
            ['DepthInterval', 'Depth Intervals']
        ];

        // Build navigation
        const navHtml = [];
        for (const [objName, displayName] of sections) {
            if (fieldsByObject[objName]?.length) {
                navHtml.push(`<a href="#csv-${objName.toLowerCase()}">${displayName}</a>`);
            }
        }
        navHtml.push('<span class="muted" style="margin-left: 20px;">See also: <a href="json_dynamic.html">JSON Format</a></span>');
        document.getElementById('nav').innerHTML = navHtml.join(' ');
        document.getElementById('nav').style.display = 'block';

        // Build content
        let contentHtml = `<section id="overview">
            <h2>Overview</h2>
            <p>The CSV export produces <strong>one row per depth interval per site</strong>. Site-level fields repeat on each row.</p>
        </section>`;

        for (const [objName, displayName] of sections) {
            const objFields = fieldsByObject[objName] || [];
            if (!objFields.length) continue;

            let tableRows = '';
            for (const f of objFields) {
                const csvCol = f.csv_column || '';
                const ftype = f.type || '';
                const fdesc = f.description || '';

                let typeHtml;
                if (valuesByEnum[ftype]) {
                    const vals = valuesByEnum[ftype].map(v => escapeHtml(v.label));
                    typeHtml = vals.join(', ');
                } else if (ftype === 'boolean') {
                    typeHtml = '<span class="type">TRUE, FALSE</span>';
                } else {
                    typeHtml = `<span class="type">${escapeHtml(ftype)}</span>`;
                }

                tableRows += `<tr><td>${escapeHtml(csvCol)}</td><td>${typeHtml}</td><td>${escapeHtml(fdesc)}</td></tr>`;
            }

            const descHtml = objName === 'DepthInterval'
                ? '<p class="description">One row per depth interval. Intervals are determined by the site\'s depth interval preset.</p>'
                : '';

            contentHtml += `<section id="csv-${objName.toLowerCase()}">
                <h2>${displayName}</h2>
                ${descHtml}
                <table>
                    <tr><th style="width:20%">CSV Column</th><th style="width:20%">Type</th><th style="width:60%">Description</th></tr>
                    ${tableRows}
                </table>
            </section>`;
        }

        document.getElementById('content').innerHTML = contentHtml;
        document.getElementById('loading').style.display = 'none';
    }

    loadData().then(render).catch(err => {
        document.getElementById('loading').innerHTML = `Error loading data: ${err.message}`;
    });
    </script>
</body>
</html>
